\chapter{Publishing Your Work On Diderot}
\label{ch:publish}

Diderot allows authors to generate interactive books from LaTeX and Markdown sources.
%
This compilation and cloud services that Diderot uses to enable this are far from complete.
%
For ease of use, we therefore strongly recommend the authors to follow certain ``best practices.''
%
In this chapter, we first describe the basic concepts of publishing on
Diderot and then describe the structure of a Diderot ``book'' and a ``booklet'' and our recommendations for organizing these to minimize mistakes.
%
For brevity, we consider LaTeX sources here, but the practices generalize to Markdown sources.
  

\begin{important}[Sources]
To go through the examples in this chapter, please clone 
%
\href{https://github.com/diderot-edu/diderot-guide}{this github repository}
%
and follow the instructions in \lstinline`INSTALL.md`. 
%
The examples are tested on Mac OS X and Ubuntu.  The binaries in \lstinline`bin` might not work on systems that are not Mac or Linux/Unix-like. 
\end{important}

\subsection{Released and Unreleased Content}

You can publish content on Diderot in two different forms: ``unreleased'' and ``released''.
%
When you first upload some content in the form of a book chapter on Diderot, the chapter is unreleased by default.
%
You can release the chapter by using Book Managemement features, but before you  do, beware that releasing should be treated as a one-way feature.
%

After you release a chapter, it becomes available to your readers, who might start taking notes on its content and discussing it, by for example asking questions to course staff.
%
In other words, released content is out in the wild and has now affected users.
%
Updating content after it is released  therefore raises a number of questions, e.g.,
\begin{itemize}
\item should it be allowed at all? (For example, fixing an error pointed out by a student makes a good question look like an unnecessary question.)

\item if it should be allowed, then under what circumstances, who decides, how should it be implemented?
\end{itemize}

Beyond these important questions, updates are complex from a technical
point of view: the key challenge is identifying what has been changed
and what has not.
%
To see why let's say that you have published and released a chapter on Diderot and later realized that you want to make some updates, and so you edited the chapter sources.
%
Now, if you want to update the released chapter on Diderot, then
Diderot needs to figure out which sections and atoms have been edited
and which ones remain the same.  This is not easy, because to figure
this out, Diderot needs information from you about what exactly you
have edited.  For example, let's say you have swapped the position of
two paragraphs in your text, this is an ambiguous change for Diderot,
because it cannot distinguish this edit from complete rewriting of the
two paragraphs (i.e., did you swap or did you rewrite?). 
%
This is important, because it impacts how the affects of the atoms on the users should be propagated.  

%
A second technical concern is treatment of deleted content.  Let's say that you have deleted a paragraph, but a student took personal notes on this paragraph.  What should happen to students' notes?  Should they also be deleted? If not' then they would be pointing to deleted content and their notes would make no sense.  

\begin{gram}[Releasing Content is One Way]
These challenges are not insurmountable but we have at this time decided to proceed with the principle that: a chapter will not be updated after it is released.
\end{gram}


\begin{gram}[Best Practices]
The best practice for publishing content on Diderot is to publish it in unreleased form first, inspect the material, and ideally have your fellow co-instructor and TAs look over the content, give you feedback (they can send feedback on unreleased content), update the content according to feedback, and then release it. 
%
As you release content, remember that it is a one-way road.
\end{gram}

\begin{gram}[Fixing Small Errors After Release]
Mistakes do happen and there are several ways to fix small errors in released chapters.

\begin{itemize}
\item \textbf{Unreleasing:}
If you accidentally released a chapter and a small amount of time has passed, or if the chapter is corrupt in a major way, you can unrelease the chapter.
%
Having unreleased it, you can update the contents as you wish, and all other user interactions  prior to the updates will be deleted.
%
After you make your updates, you can release the chapter as usual.
%

\item \textbf{Online edits:}
for small corrections, perhaps the easiest way is to edit the affected atoms online on Diderot.  For example, this is usually sufficient to fix small typos.  (Don't forget to update your LaTeX or Markdown source).

\item \textbf{XML edits:}
%
For larger changes, you can edit the XML of the chapter directly and reupload the XML.  When editing the XML, it is very important not to alter \lstinline`label` fields.  The contents of all else can be edited.

\item \textbf{LaTeX edits:}
Certain LaTeX and Markdown edits are also feasible.  For example, you can simply add new content to the tail of your LaTeX/Markdown chapter source but as you do this, it is very important to not alter any of the prior content. 
\end{itemize}
\end{gram}

\begin{gram}[The Ultimate Method]
If you are using LaTeX, then there is a way to write your sources in such that essentially any updates except deletion of released sections or atoms are possible after release.  The idea is to completely atomize your chapter by making sure that each piece of text is inside of an atom and giving each section, group, and each atom a unique label and never change these labels.
%
This approach could be feasible for small texts such as assignments but tends to be too labor intensive for larger text such as book chapters.
\end{gram}


\section{Structuring your Sources}
\label{sec:publish::latex-structure}
%
We recommend following the structure
of the book and the booklet examples included in this guide source
code (in folders `book` and `booklet`) and described here.
%
As examples, 
the folders \lstinline`book` and \lstinline`booklet` in guide sources contain several files.
%
\begin{itemize}
\item \lstinline`book.tex`

This is the top level file for PDF generation.  It is a conventional LaTeX document is but is organized carefully for Diderot compatibility.

\item \lstinline`book-html.tex`

This is the top level file for html generation.  It is mostly a copy of \lstinline`book.tex` but it uses slightly different packages.

\item \lstinline`templates/diderot.sty`

Supplies diderot definitions needed for compiling latex to pdf's.
You don't need to modify this file.

\item \lstinline`templates/packages.sty`

Supplies packages for PDF generation.  You can add whatever package
you want.  Most of these packages, except perhaps basics ones and AMS
Math packages, will be ignored for XML generation.  It is important not to include any command definitions in this file.

\item \lstinline`templates/preamble.tex` 

Supplies your macros that will be used by generating a PDF via pdflatex.  All macros should be included here and no packages should be included (use \lstinline`packages.sty` for packages.  


\item \lstinline`templates/preamble-diderot.tex` 

Equivalent of \lstinline`preamble.tex` but it is customized for XML output.  This usually means that most macros will remain the same but some will be simplified to work with `pandoc`.  If you don't need to extensive customization, you can keep just one \lstinline`preamble.tex` and \lstinline`input` that file in your \lstinline`preamble-diderot.tex`, as in the \lstinline`booklet` example.
%
\begin{lstlisting}
% File: preamble-diderot.tex

% Includes all of preamble.tex
\input{./templates/preamble.tex}

% Redefine \mybold command defined in preamble.tex for Diderot.
\renewcommand{\mybold}[1]{\textbf{#1}}
\end{lstlisting}
\end{itemize}    

\begin{important}
The idea behind organizing \lstinline`preamble-diderot.tex` by including \lstinline`preamble.tex` and modifying it as needed is to minimize human errors that can be more difficult to fix once published on Diderot. 
%
We strongly recommend the authors to follow this practice.
\end{important}



To simplify publishing on Diderot, we recommend organizing your booklet and book sources as outlined below. 

\begin{gram}[Booklets]
Booklets are books that don't have parts. We recommend creating one directory per chapter and placing a single \lstinline`main.tex` (a chapter specific name could also be used) file to include all contain that you want.  
%
Place all media (images, videos etc) under a media/ subdirectory. 
\begin{itemize}  
\item \lstinline`ch1/main.tex` or \lstinline`ch1/ch1.tex`
\item \lstinline`ch1/media/`: all my media files, *.png *.jgp, *.graffle, etc.
\item \lstinline`ch2/main.tex` or \lstinline`ch2/ch2.tex`
\item \lstinline`ch2/media/`: all my media files for chapter 2, *.png *.jgp, *.graffle, etc.
\item \lstinline`ch3/main.tex` or \lstinline`ch3/ch3.tex`
\end{itemize}
\end{gram}

\begin{gram}[Books]
Books have parts and chapters. We recommend structuring these as follows, where `ch1, ch2` etc can be replaced with names of your choice.
%
\begin{itemize}
\item \lstinline`part1/ch1.tex`
\item \lstinline`part1/ch2.tex`
\item \lstinline`part1/media-ch1/`
\item \lstinline`part1/media-ch2/`
\item \lstinline`part2/ch3.tex`
\item \lstinline`part2/ch4.tex`
\item \lstinline`part2/ch5.tex`
\item \lstinline`part2/media-ch3/`
\item \lstinline`part2/media-ch4/`
\item \lstinline`part2/media-ch5/`
\end{itemize}
   
\end{gram}


\begin{gram}[Making PDF and HTML]
Inside the \lstinline`book\` and \lstinline`booklet\` directories, 
you can use \lstinline`pdflatex` to generate a PDF output.  See the corresponding \lstinline`Makefile`.
%
For example, you can  invoke the \lstinline`Makefile` as follows to make a PDF:
\begin{lstlisting}
$ make pdf
$ make html
\end{lstlisting}
\end{gram}


\begin{gram}[Making PDF/HTML for a Single Chapter]
To make specific chapters,  extend the Makefile to compile each chapter separately.  See the \lstinline`Makefile` in book or booklet as examples.
%
For example, you can compile the chapter \lstinline`probability` in the \lstinline`book` directory as follows.
\begin{lstlisting}
$ make probability
\end{lstlisting}

To generate HTML for a single chapter, update \lstinline`book-html.tex` to exclude all other chapters and run \lstinline`make html`.

\end{gram}


\begin{gram}[Making XML]
XML generation proceeds on a chapter by chapter basis.
%
To generate xml, simply use the Makefile provided as follows.
%
\begin{lstlisting}
$ make ch2/main.xml
\end{lstlisting}
%

To obtain more information from a run, you can turn on the verbose option.
%
\begin{lstlisting}
$ make verbose=true ch2/main.xml
\end{lstlisting}

Beware that you will likely see many warnings.  For this reason the utility of the verbose flag is not particularly high.
\end{gram}

\begin{important}[PDF before XML]
Before generating the XML for a chapter, please check first that you can generate PDF for the chapter.  This is because XML generation is relatively ``forgiving'' and, for example, simply omits undefined macros without complaining.  By generating PDF first, the author could avoid many errors that can be more time-consuming to fix after the material is published on Diderot.
\end{important}

\begin{note}
The ``PDF before XML''
\end{note}

\begin{gram}
Error messages from the XML translator are not particularly useful at this time.  But, if you are able to generate a PDF and HTML (using \lstinline`pandoc`), then you should be able to generate an XML. 
%
If you encounter a puzzling error try the "debug" version which will print the atoms as it goes through the input.
%
\begin{lstlisting}
$ make debug=true probability/theory.xml
\end{lstlisting}

If that fails, there is another relatively simply way to debug, see \href{sec:dc::internals}{Section Internals} for additional information.
\end{gram}

\begin{gram}[Using DC directly]
Assuming that you structure your book as suggested above, then you will mostly be using the Makefile but you could also use the DC tools directly. 
%
This tools translates the given input LaTeX file to xml.

\begin{lstlisting}
$ dc  -meta ./meta -preamble preamble.tex input.tex -o output.xml
\end{lstlisting}

To turn on the debug mode, simply pass the flag \lstinline`-d`.
\begin{lstlisting}
$ dc  -d -meta ./meta -preamble preamble.tex input.tex -o output.xml
\end{lstlisting}

The meta folder contains some files that may be used in the XML translation.  You can ignore this directory to start with and then start populating it based on your needs.  The main file that you might want to add are Kate highlighting specifications to be used for highlighting code.
\end{gram}


%% ## Tool: tex2tex
%% This tools reads in your LaTeX sources, parses them, and writes it back.  It drops comments and normalized the whitespace but should otherwise return back a LaTeX file that is essentially the same as the input file.   You should not need to use this binary, which is primarily used for testing during development.

%% Examples: 
%% {lstlisting}
%% $ bin/tex2tex ./graph-contraction/star.tex -o ./s.tex
%% $ diff ./graph-contraction/star.tex ./s.tex
%% {lstlisting}
%% ### Tool: texel
%% This tool "normalizes" your latex sources.  This means that it

%% * atomizes your code, wrapping each paragraph into a non-descript "gram" atom if it is not already wrapped.

%% * wraps each atom by a "group", if not already wrapped by one.

%% * gives each segment (section, subsection, subsubsection, paragraph, atom) of the input file a label and it wraps each atom into a "group" if it is not already in a group.  A group is one of "cluster" "flex" "mproblem" (multipart problem).  

%% Generated labels have the form 
%% {lstlisting}
%% kind_prefix:chapter_label:segment_label
%% {lstlisting}
%% Here kind_prefix could for exmaple be
%% * `sec`, for section, subsection, subsubsection, paragraph
%% * `xmpl`, `thm`, for an example or a theorem.

%% The chapter_label is extracted from the chapter label given.  For exmaple, if the label has any one of the form 
%% {lstlisting}
%% ch:star | chapter:star | ch_star | ch__star | ch:_star | chap:_star
%% {lstlisting}
%% chapter_label will be `star`.

%% The tool takes the label, split it at the delimiters [:_]+ and if the prefix starts with "ch" it take the rest of the label as the chapter label.
 
%% Some example full labels:
%% * xmpl:star:simpleexample
%% * thm:star:costbound

